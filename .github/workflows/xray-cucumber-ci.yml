name: BDD Tests & Xray Report

# ------------------------------------------------------------------------
# TRIGGER SECTION
# We use 'workflow_dispatch' to allow manual input of the Test Plan Key.
# ------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      test_plan_key:
        description: 'Jira Issue Key for the Xray Test Plan (e.g., REG-101)'
        required: true
        default: 'REGRESSION-RUN'

jobs:
  run_tests_and_report:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java Environment
      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      # 3. Build and Run Tests
      # We give this step an ID for reference, but it can now fail without stopping the next step
      - name: ⚙️ Run Maven Tests
        id: run-tests
        run: mvn clean test -DskipTests=false

      # 4. Upload Report to Xray
      # CRITICAL FIX: The 'if: always()' condition ensures this step executes
      # even if the previous 'Run Maven Tests' step fails due to test failures.
      - name: ⬆️ Upload Test Report to Xray
        if: always()
        uses: mikepenz/xray-action@v2.4.5
        with:
          # This action requires the test format and paths
          testFormat: "cucumber"
          testPaths: "target/cucumber-report/cucumber.json"

          # Credentials
          username: ${{ secrets.XRAY_CLIENT_ID }}
          password: ${{ secrets.XRAY_CLIENT_SECRET }}

          # Xray Test Plan Key
          # FIX: Removed 'summary' and 'description' as they are not supported by this action.
          testPlanKey: ${{ github.event.inputs.test_plan_key }}