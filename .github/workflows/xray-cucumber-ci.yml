name: BDD Tests & Xray Report

# ------------------------------------------------------------------------
# TRIGGER SECTION
# We use 'workflow_dispatch' to allow manual input of the Test Plan Key.
# ------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      test_plan_key:
        description: 'Jira Issue Key for the Xray Test Plan (e.g., REG-101)'
        required: true
        default: 'REGRESSION-RUN'

jobs:
  run_tests_and_report:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java Environment
      # Note: Using Java 25 as requested. If this fails, switch to '21'.
      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      # 3. Build and Run Tests
      # This runs the TestRunner.java and produces target/cucumber-report/cucumber.json
      - name: ⚙️ Run Maven Tests
        run: mvn clean test -DskipTests=false

      # 4. Upload Report to Xray
      - name: ⬆️ Upload Test Report to Xray
        # Using the reliable market-square action, confirmed by Xray documentation strategy
        uses:  mikepenz/xray-action@v2.4.5
        with:
          # Required format: Cucumber/Gherkin
          format: "cucumber"
          # Report path as defined in TestRunner.java
          report_path: target/cucumber-report/cucumber.json
          test_plan_key: ${{ github.event.inputs.test_plan_key }}
          summary: "Automated Run for Plan ${{ github.event.inputs.test_plan_key }} (Commit: ${{ github.sha }}), It is forbidden to specify block composed value at the same line as key"
          description: Test execution triggered from GitHub Actions.
        # Credentials passed via environment variables
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}