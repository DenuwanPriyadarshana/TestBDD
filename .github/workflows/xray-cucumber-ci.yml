name: BDD Tests & Xray Report

# ------------------------------------------------------------------------
# TRIGGER SECTION
# We use 'workflow_dispatch' to allow manual input of the Test Plan Key.
# ------------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      test_plan_key:
        description: 'Jira Issue Key for the Xray Test Plan (e.g., REG-101)'
        required: true
        default: 'REGRESSION-RUN'

jobs:
  run_tests_and_report:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Java Environment
      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          # Note: Changed to '21' for stability, as Java 25 is not yet an LTS or widely supported GH Actions runner version.
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. Build and Run Tests
      # This runs the TestRunner.java and produces target/cucumber-report/cucumber.json
      - name: ⚙️ Run Maven Tests
        run: mvn clean test -DskipTests=false

      # 4. Upload Report to Xray
      - name: ⬆️ Upload Test Report to Xray
        # FIX #1: Corrected action path to the actively maintained 'mikepenz/xray-action'.
        # We use '@v5' which is the latest stable version.
        uses: mikepenz/xray-action@v5
        with:
          # --- Xray Cloud Authentication (Required for your allybees.atlassian.net instance) ---
          # Note: We pass the Client ID/Secret directly as 'username' and 'password' in 'v5' of this action.
          username: ${{ secrets.XRAY_CLIENT_ID }}
          password: ${{ secrets.XRAY_CLIENT_SECRET }}
          xrayCloud: true # Must be set to true for Jira Cloud instances.

          # --- Report Details ---
          testFormat: "cucumber" # The parameter name is now 'testFormat'
          testPaths: "target/cucumber-report/cucumber.json" # The parameter name is now 'testPaths'
          testPlanKey: ${{ github.event.inputs.test_plan_key }}

          # FIX #2: Corrected YAML syntax error by moving the 'summary' block to the next line and removing the invalid comma.
          summary: |
            Automated Run for Plan ${{ github.event.inputs.test_plan_key }}
            Commit: ${{ github.sha }}
          description: Test execution triggered from GitHub Actions.